!function(e,t){'object'==typeof exports&&'undefined'!=typeof module?t(exports,require('leaflet'),require('esri-leaflet')):'function'==typeof define&&define.amd?define(['exports','leaflet','esri-leaflet'],t):t((e.L=e.L||{},e.L.esri=e.L.esri||{},e.L.esri.Geocoding=e.L.esri.Geocoding||{}),e.L,e.L.esri)}(this,function(t,e,s){'use strict';
function u(e){return new y(e)};
function l(e){return new m(e)};
function a(e){return new v(e)};
function x(e){return new o(e)};
function r(e,t){return new f(e,t)};
function n(e){return new p(e)};
function b(e){return new g(e)};
function S(e){return new c(e)};
function C(e){return new h(e)};
function L(e){return new d(e)};
e='default'in e?e.default:e;
var y=s.Task.extend({path:'findAddressCandidates',params:{outSr:4326,forStorage:!1,outFields:'*',maxLocations:20},setters:{address:'address',neighborhood:'neighborhood',city:'city',subregion:'subregion',region:'region',postal:'postal',country:'country',text:'singleLine',category:'category',token:'token',key:'magicKey',fields:'outFields',forStorage:'forStorage',maxLocations:'maxLocations'},initialize:function(e){e=e||{},e.url=e.url||i,s.Task.prototype.initialize.call(this,e)},within:function(t){return t=e.latLngBounds(t),this.params.searchExtent=s.Util.boundsToExtent(t),this},nearby:function(t,s){return t=e.latLng(t),this.params.location=t.lng+','+t.lat,this.params.distance=Math.min(Math.max(s,2e3),5e4),this},run:function(e,t){return this.options.customParam&&(this.params[this.options.customParam]=this.params.singleLine,delete this.params.singleLine),this.request(function(s,i){var o=this._processGeocoderResponse,n=s?void 0:o(i);
e.call(t,s,{results:n},i)},this)},_processGeocoderResponse:function(t){for(var n=[],o=0;o<t.candidates.length;o++){var i=t.candidates[o];
if(i.extent)var r=s.Util.extentToBounds(i.extent);
n.push({text:i.address,bounds:r,score:i.score,latlng:e.latLng(i.location.y,i.location.x),properties:i.attributes})};
return n}}),m=s.Task.extend({path:'reverseGeocode',params:{outSR:4326,returnIntersection:!1},setters:{distance:'distance',language:'langCode',intersection:'returnIntersection'},initialize:function(e){e=e||{},e.url=e.url||i,s.Task.prototype.initialize.call(this,e)},latlng:function(t){return t=e.latLng(t),this.params.location=t.lng+','+t.lat,this},run:function(t,s){return this.request(function(i,o){var n;
n=i?void 0:{latlng:e.latLng(o.location.y,o.location.x),address:o.address},t.call(s,i,n,o)},this)}}),v=s.Task.extend({path:'suggest',params:{},setters:{text:'text',category:'category',countries:'countryCode',maxSuggestions:'maxSuggestions'},initialize:function(e){e=e||{},e.url||(e.url=i,e.supportsSuggest=!0),s.Task.prototype.initialize.call(this,e)},within:function(t){t=e.latLngBounds(t),t=t.pad(.5);
var i=t.getCenter(),o=t.getNorthWest();
return this.params.location=i.lng+','+i.lat,this.params.distance=Math.min(Math.max(i.distanceTo(o),2e3),5e4),this.params.searchExtent=s.Util.boundsToExtent(t),this},nearby:function(t,s){return t=e.latLng(t),this.params.location=t.lng+','+t.lat,this.params.distance=Math.min(Math.max(s,2e3),5e4),this},run:function(e,t){if(this.options.supportsSuggest)return this.request(function(s,i){e.call(t,s,i,i)},this);
console.warn('this geocoding service does not support asking for suggestions')}}),o=s.Service.extend({initialize:function(e){e=e||{},e.url?(s.Service.prototype.initialize.call(this,e),this._confirmSuggestSupport()):(e.url=i,e.supportsSuggest=!0,s.Service.prototype.initialize.call(this,e))},geocode:function(){return u(this)},reverse:function(){return l(this)},suggest:function(){return a(this)},_confirmSuggestSupport:function(){this.metadata(function(e,t){e||(t.capabilities&&t.capabilities.indexOf('Suggest')>-1?this.options.supportsSuggest=!0:this.options.supportsSuggest=!1,this.options.customParam=t.singleLineAddressField.name)},this)}}),f=e.Evented.extend({options:{zoomToResult:!0,useMapBounds:12,searchBounds:null},initialize:function(t,s){if(e.Util.setOptions(this,s),this._control=t,!s||!s.providers||!s.providers.length)throw new Error('You must specify at least one provider');
this._providers=s.providers},_geocode:function(t,s,i){var o,n=0,r=[],l=e.Util.bind(function(e,s){n--,e||(s&&(r=r.concat(s)),n<=0&&(o=this._boundsFromResults(r),this.fire('results',{results:r,bounds:o,latlng:o?o.getCenter():void 0,text:t},!0),this.options.zoomToResult&&o&&this._control._map.fitBounds(o),this.fire('load')))},this);
if(s)n++,i.results(t,s,this._searchBounds(),l);
else for(var a=0;a<this._providers.length;a++)n++,this._providers[a].results(t,s,this._searchBounds(),l)},_suggest:function(t){var n=this._providers.length,r=e.Util.bind(function(t,s){return e.Util.bind(function(e,i){if(!e){var o;
if(n-=1,t.length<2)return this._suggestions.innerHTML='',void(this._suggestions.style.display='none');
if(i.length)for(o=0;o<i.length;o++)i[o].provider=s;
else this._control._renderSuggestions(i);
if(s._lastRender!==t&&s.nodes){for(o=0;o<s.nodes.length;o++)s.nodes[o].parentElement&&this._control._suggestions.removeChild(s.nodes[o]);
s.nodes=[]};
i.length&&this._control._input.value===t&&(this._control.clearSuggestions(s.nodes),s._lastRender=t,s.nodes=this._control._renderSuggestions(i),this._control._nodes=[])}},this)},this);
this._pendingSuggestions=[];
for(var s=0;s<this._providers.length;s++){var i=this._providers[s],o=i.suggestions(t,this._searchBounds(),r(t,i));
this._pendingSuggestions.push(o)}},_searchBounds:function(){return null!==this.options.searchBounds?this.options.searchBounds:!1===this.options.useMapBounds?null:!0===this.options.useMapBounds?this._control._map.getBounds():this.options.useMapBounds<=this._control._map.getZoom()?this._control._map.getBounds():null},_boundsFromResults:function(t){if(t.length){for(var l=e.latLngBounds([0,0],[0,0]),o=[],a=[],n=t.length-1;n>=0;n--){var s=t[n];
a.push(s.latlng),s.bounds&&s.bounds.isValid()&&!s.bounds.equals(l)&&o.push(s.bounds)};
for(var r=e.latLngBounds(a),i=0;i<o.length;i++)r.extend(o[i]);
return r}},_getAttribution:function(){for(var s=[],t=this._providers,e=0;e<t.length;e++)t[e].options.attribution&&s.push(t[e].options.attribution);
return s.join(', ')}}),p=o.extend({options:{label:'Places and Addresses',maxResults:5},suggestions:function(e,t,s){var i=this.suggest().text(e);
return t&&i.within(t),this.options.countries&&i.countries(this.options.countries),this.options.categories&&i.category(this.options.categories),i.maxSuggestions(this.options.maxResults),i.run(function(e,t,i){var n=[];
if(!e)for(;i.suggestions.length&&n.length<=this.options.maxResults-1;){var o=i.suggestions.shift();
o.isCollection||n.push({text:o.text,unformattedText:o.text,magicKey:o.magicKey})};
s(e,n)},this)},results:function(e,t,s,o){var i=this.geocode().text(e);
return t&&i.key(t),i.maxLocations(this.options.maxResults),s&&i.within(s),this.options.forStorage&&i.forStorage(!0),i.run(function(e,t){o(e,t.results)},this)}}),g=e.Control.extend({includes:e.Evented.prototype,options:{position:'topleft',collapseAfterResult:!0,expanded:!1,allowMultipleResults:!0,placeholder:'Search for places or addresses',title:'Location Search'},initialize:function(t){e.Util.setOptions(this,t),t&&t.providers&&t.providers.length||(t||(t={}),t.providers=[n()]),this._geosearchCore=r(this,t),this._geosearchCore._providers=t.providers,this._geosearchCore.addEventParent(this);
for(var s=0;s<this._geosearchCore._providers.length;s++)this._geosearchCore._providers[s].addEventParent(this);
this._geosearchCore._pendingSuggestions=[],e.Control.prototype.initialize.call(t)},_renderSuggestions:function(t){var d;
t.length>0&&(this._suggestions.style.display='block'),this._suggestions.style.maxHeight=this._map.getSize().y-this._suggestions.offsetTop-this._wrapper.offsetTop-10+'px';
for(var i,o,a=[],u=[],l=0;l<t.length;l++){var s=t[l];
if(!o&&this._geosearchCore._providers.length>1&&d!==s.provider.options.label&&(o=e.DomUtil.create('span','geocoder-control-header',this._suggestions),o.textContent=s.provider.options.label,o.innerText=s.provider.options.label,d=s.provider.options.label,a.push(o)),i||(i=e.DomUtil.create('ul','geocoder-control-list',this._suggestions)),-1===u.indexOf(s.text)){var r=e.DomUtil.create('li','geocoder-control-suggestion',i);
r.innerHTML=s.text,r.provider=s.provider,r['data-magic-key']=s.magicKey,r.unformattedText=s.unformattedText}
else for(var n=0;n<i.childNodes.length;n++)i.childNodes[n].innerHTML===s.text&&(i.childNodes[n]['data-magic-key']+=','+s.magicKey);
u.push(s.text)};
return e.DomUtil.removeClass(this._input,'geocoder-control-loading'),a.push(i),a},_boundsFromResults:function(t){if(t.length){for(var l=e.latLngBounds([0,0],[0,0]),o=[],a=[],n=t.length-1;n>=0;n--){var s=t[n];
a.push(s.latlng),s.bounds&&s.bounds.isValid()&&!s.bounds.equals(l)&&o.push(s.bounds)};
for(var r=e.latLngBounds(a),i=0;i<o.length;i++)r.extend(o[i]);
return r}},clear:function(){this._suggestions.innerHTML='',this._suggestions.style.display='none',this._input.value='',this.options.collapseAfterResult&&(this._input.placeholder='',e.DomUtil.removeClass(this._wrapper,'geocoder-control-expanded')),!this._map.scrollWheelZoom.enabled()&&this._map.options.scrollWheelZoom&&this._map.scrollWheelZoom.enable()},clearSuggestions:function(){if(this._nodes)for(var e=0;e<this._nodes.length;e++)this._nodes[e].parentElement&&this._suggestions.removeChild(this._nodes[e])},_setupClick:function(){e.DomUtil.addClass(this._wrapper,'geocoder-control-expanded'),this._input.focus()},disable:function(){this._input.disabled=!0,e.DomUtil.addClass(this._input,'geocoder-control-input-disabled'),e.DomEvent.removeListener(this._wrapper,'click',this._setupClick,this)},enable:function(){this._input.disabled=!1,e.DomUtil.removeClass(this._input,'geocoder-control-input-disabled'),e.DomEvent.addListener(this._wrapper,'click',this._setupClick,this)},getAttribution:function(){for(var t=[],e=0;e<this._providers.length;e++)this._providers[e].options.attribution&&t.push(this._providers[e].options.attribution);
return t.join(', ')},geocodeSuggestion:function(e){var t=e.target||e.srcElement;
t.classList.length<1&&(t=t.parentNode),this._geosearchCore._geocode(t.unformattedText,t['data-magic-key'],t.provider),this.clear()},onAdd:function(t){s.Util.setEsriAttribution(t),this._map=t,this._wrapper=e.DomUtil.create('div','geocoder-control'),this._input=e.DomUtil.create('input','geocoder-control-input leaflet-bar',this._wrapper),this._input.title=this.options.title,this.options.expanded&&(e.DomUtil.addClass(this._wrapper,'geocoder-control-expanded'),this._input.placeholder=this.options.placeholder),this._suggestions=e.DomUtil.create('div','geocoder-control-suggestions leaflet-bar',this._wrapper);
var i=this._geosearchCore._getAttribution();
return t.attributionControl.addAttribution(i),e.DomEvent.addListener(this._input,'focus',function(t){this._input.placeholder=this.options.placeholder,e.DomUtil.addClass(this._wrapper,'geocoder-control-expanded')},this),e.DomEvent.addListener(this._wrapper,'click',this._setupClick,this),e.DomEvent.addListener(this._suggestions,'mousedown',this.geocodeSuggestion,this),e.DomEvent.addListener(this._suggestions,'touchend',this.geocodeSuggestion,this),e.DomEvent.addListener(this._input,'blur',function(e){this.clear()},this),e.DomEvent.addListener(this._input,'keydown',function(t){var d=(t.target||t.srcElement).value;
e.DomUtil.addClass(this._wrapper,'geocoder-control-expanded');
for(var a,s=this._suggestions.querySelectorAll('.geocoder-control-suggestion'),i=this._suggestions.querySelectorAll('.geocoder-control-selected')[0],n=0;n<s.length;n++)if(s[n]===i){a=n;
break};
switch(t.keyCode){case 13:i?(this._geosearchCore._geocode(i.unformattedText,i['data-magic-key'],i.provider),this.clear()):this.options.allowMultipleResults&&d.length>=2?(this._geosearchCore._geocode(this._input.value,void 0),this.clear()):1===s.length?(e.DomUtil.addClass(s[0],'geocoder-control-selected'),this._geosearchCore._geocode(s[0].innerHTML,s[0]['data-magic-key'],s[0].provider)):(this.clear(),this._input.blur()),e.DomEvent.preventDefault(t);
break;
case 38:i&&e.DomUtil.removeClass(i,'geocoder-control-selected');
var u=s[a-1];
i&&u?e.DomUtil.addClass(u,'geocoder-control-selected'):e.DomUtil.addClass(s[s.length-1],'geocoder-control-selected'),e.DomEvent.preventDefault(t);
break;
case 40:i&&e.DomUtil.removeClass(i,'geocoder-control-selected');
var l=s[a+1];
i&&l?e.DomUtil.addClass(l,'geocoder-control-selected'):e.DomUtil.addClass(s[0],'geocoder-control-selected'),e.DomEvent.preventDefault(t);
break;
default:for(var r=0;r<this._geosearchCore._pendingSuggestions.length;r++){var o=this._geosearchCore._pendingSuggestions[r];
o&&o.abort&&!o.id&&o.abort()}}},this),e.DomEvent.addListener(this._input,'keyup',e.Util.throttle(function(t){var s=t.which||t.keyCode,i=(t.target||t.srcElement).value;
return i.length<2?(this._suggestions.innerHTML='',this._suggestions.style.display='none',void e.DomUtil.removeClass(this._input,'geocoder-control-loading')):27===s?(this._suggestions.innerHTML='',void(this._suggestions.style.display='none')):void(13!==s&&38!==s&&40!==s&&this._input.value!==this._lastValue&&(this._lastValue=this._input.value,e.DomUtil.addClass(this._input,'geocoder-control-loading'),this._geosearchCore._suggest(i)))},50,this),this),e.DomEvent.disableClickPropagation(this._wrapper),e.DomEvent.addListener(this._suggestions,'mouseover',function(e){t.scrollWheelZoom.enabled()&&t.options.scrollWheelZoom&&t.scrollWheelZoom.disable()}),e.DomEvent.addListener(this._suggestions,'mouseout',function(e){!t.scrollWheelZoom.enabled()&&t.options.scrollWheelZoom&&t.scrollWheelZoom.enable()}),this._geosearchCore.on('load',function(t){e.DomUtil.removeClass(this._input,'geocoder-control-loading'),this.clear(),this._input.blur()},this),this._wrapper}}),c=s.FeatureLayerService.extend({options:{label:'Feature Layer',maxResults:5,bufferRadius:1e3,formatSuggestion:function(e){return e.properties[this.options.searchFields[0]]}},initialize:function(e){s.FeatureLayerService.prototype.initialize.call(this,e),'string'==typeof this.options.searchFields&&(this.options.searchFields=[this.options.searchFields]),this._suggestionsQuery=this.query(),this._resultsQuery=this.query()},suggestions:function(e,t,s){var i=this._suggestionsQuery.where(this._buildQuery(e)).returnGeometry(!1);
return t&&i.intersects(t),this.options.idField&&i.fields([this.options.idField].concat(this.options.searchFields)),i.run(function(e,t,i){if(e)s(e,[]);
else{this.options.idField=i.objectIdFieldName;
for(var r=[],n=t.features.length-1;n>=0;n--){var o=t.features[n];
r.push({text:this.options.formatSuggestion.call(this,o),unformattedText:o.properties[this.options.searchFields[0]],magicKey:o.id})};
s(e,r.slice(0,this.options.maxResults))}},this)},results:function(t,s,i,n){var o=this._resultsQuery;
return s?(delete o.params.where,o.featureIds([s])):o.where(this._buildQuery(t)),i&&o.within(i),o.run(e.Util.bind(function(e,t){for(var r=[],i=0;i<t.features.length;i++){var s=t.features[i];
if(s){var o=this._featureBounds(s),a={latlng:o.getCenter(),bounds:o,text:this.options.formatSuggestion.call(this,s),properties:s.properties,geojson:s};
r.push(a),delete this._resultsQuery.params.objectIds}};
n(e,r)},this))},orderBy:function(e,t){this._suggestionsQuery.orderBy(e,t)},_buildQuery:function(e){for(var t=[],s=this.options.searchFields.length-1;s>=0;s--){var i='upper("'+this.options.searchFields[s]+'")';
t.push(i+' LIKE upper(\'%'+e+'%\')')};
return this.options.where?this.options.where+' AND ('+t.join(' OR ')+')':t.join(' OR ')},_featureBounds:function(t){var n=e.geoJson(t);
if('Point'===t.geometry.type){var s=n.getBounds().getCenter(),i=this.options.bufferRadius/40075017*360/Math.cos(180/Math.PI*s.lat),o=this.options.bufferRadius/40075017*360;
return e.latLngBounds([s.lat-o,s.lng-i],[s.lat+o,s.lng+i])};
return n.getBounds()}}),h=s.MapService.extend({options:{layers:[0],label:'Map Service',bufferRadius:1e3,maxResults:5,formatSuggestion:function(e){return e.properties[e.displayFieldName]+' <small>'+e.layerName+'</small>'}},initialize:function(e){s.MapService.prototype.initialize.call(this,e),this._getIdFields()},suggestions:function(e,t,s){return this.find().text(e).fields(this.options.searchFields).returnGeometry(!1).layers(this.options.layers).run(function(e,t,i){var u=[];
if(!e){var d=Math.min(this.options.maxResults,t.features.length);
i.results=i.results.reverse();
for(var r=0;r<d;r++){var o=t.features[r],a=i.results[r],n=a.layerId,l=this._idFields[n];
o.layerId=n,o.layerName=this._layerNames[n],o.displayFieldName=this._displayFields[n],l&&u.push({text:this.options.formatSuggestion.call(this,o),unformattedText:o.properties[o.displayFieldName],magicKey:a.attributes[l]+':'+n})}};
s(e,u.reverse())},this)},results:function(e,t,s,o){var n,r=[];
if(t){var a=t.split(':')[0],i=t.split(':')[1];
n=this.query().layer(i).featureIds(a)}
else n=this.find().text(e).fields(this.options.searchFields).layers(this.options.layers);
return n.run(function(e,t,s){if(!e){s.results&&(s.results=s.results.reverse());
for(var a=0;a<t.features.length;a++){var n=t.features[a];
if(i=i||s.results[a].layerId,n&&void 0!==i){var l=this._featureBounds(n);
n.layerId=i,n.layerName=this._layerNames[i],n.displayFieldName=this._displayFields[i];
var u={latlng:l.getCenter(),bounds:l,text:this.options.formatSuggestion.call(this,n),properties:n.properties,geojson:n};
r.push(u)}}};
o(e,r.reverse())},this)},_featureBounds:function(t){var n=e.geoJson(t);
if('Point'===t.geometry.type){var s=n.getBounds().getCenter(),i=this.options.bufferRadius/40075017*360/Math.cos(180/Math.PI*s.lat),o=this.options.bufferRadius/40075017*360;
return e.latLngBounds([s.lat-o,s.lng-i],[s.lat+o,s.lng+i])};
return n.getBounds()},_layerMetadataCallback:function(t){return e.Util.bind(function(e,s){if(!e){this._displayFields[t]=s.displayField,this._layerNames[t]=s.name;
for(var i=0;i<s.fields.length;i++){var o=s.fields[i];
if('esriFieldTypeOID'===o.type){this._idFields[t]=o.name;
break}}}},this)},_getIdFields:function(){this._idFields={},this._displayFields={},this._layerNames={};
for(var e=0;e<this.options.layers.length;e++){var t=this.options.layers[e];
this.get(t,{},this._layerMetadataCallback(t))}}}),d=o.extend({options:{label:'Geocode Server',maxResults:5},suggestions:function(e,t,s){if(this.options.supportsSuggest){var i=this.suggest().text(e);
return t&&i.within(t),i.run(function(e,t,i){var n=[];
if(!e)for(;i.suggestions.length&&n.length<=this.options.maxResults-1;){var o=i.suggestions.shift();
o.isCollection||n.push({text:o.text,unformattedText:o.text,magicKey:o.magicKey})};
s(e,n)},this)};
return s(void 0,[]),!1},results:function(e,t,s,i){var o=this.geocode().text(e);
return t&&o.key(t),o.maxLocations(this.options.maxResults),s&&o.within(s),o.run(function(e,t){i(e,t.results)},this)}}),i='https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/';
t.WorldGeocodingServiceUrl=i,t.VERSION='2.2.8',t.Geocode=y,t.geocode=u,t.ReverseGeocode=m,t.reverseGeocode=l,t.Suggest=v,t.suggest=a,t.GeocodeService=o,t.geocodeService=x,t.Geosearch=g,t.geosearch=b,t.GeosearchCore=f,t.geosearchCore=r,t.ArcgisOnlineProvider=p,t.arcgisOnlineProvider=n,t.FeatureLayerProvider=c,t.featureLayerProvider=S,t.MapServiceProvider=h,t.mapServiceProvider=C,t.GeocodeServiceProvider=d,t.geocodeServiceProvider=L});