!function(t,e){'object'==typeof exports&&'undefined'!=typeof module?e(exports,require('leaflet')):'function'==typeof define&&define.amd?define(['exports','leaflet'],e):e((t.L=t.L||{},t.L.esri=t.L.esri||{}),t.L)}(this,function(t,e){'use strict';function T(t){var i='';t.f=t.f||'json';for(var r in t)if(t.hasOwnProperty(r)){var n,e=t[r],s=Object.prototype.toString.call(e);i.length&&(i+='&'),n='[object Array]'===s?'[object Object]'===Object.prototype.toString.call(e[0])?JSON.stringify(e):e.join(','):'[object Object]'===s?JSON.stringify(e):'[object Date]'===s?e.valueOf():e,i+=encodeURIComponent(r)+'='+encodeURIComponent(n)};return i};function M(t,i){var s=new window.XMLHttpRequest;return s.onerror=function(r){s.onreadystatechange=e.Util.falseFn,t.call(i,{error:{code:500,message:'XMLHttpRequest error'}},null)},s.onreadystatechange=function(){var r,n;if(4===s.readyState){try{r=JSON.parse(s.responseText)}catch(o){r=null,n={code:500,message:'Could not parse response as JSON. This could also be caused by a CORS or XMLHttpRequest error.'}};!n&&r.error&&(n=r.error,r=null),s.onerror=e.Util.falseFn,t.call(i,n,r)}},s.ontimeout=function(){this.onerror()},s};function pt(t,e,i,s){var r=M(i,s);return r.open('POST',t),void 0!==s&&null!==s&&void 0!==s.options&&(r.timeout=s.options.timeout),r.setRequestHeader('Content-Type','application/x-www-form-urlencoded; charset=UTF-8'),r.send(T(e)),r};function dt(t,e,i,s){var r=M(i,s);return r.open('GET',t+'?'+T(e),!0),void 0!==s&&null!==s&&void 0!==s.options&&(r.timeout=s.options.timeout),r.send(null),r};function mt(t,e,i,s){var o=T(e),r=M(i,s),n=(t+'?'+o).length;if(n<=2e3&&a.cors?r.open('GET',t+'?'+o):n>2e3&&a.cors&&(r.open('POST',t),r.setRequestHeader('Content-Type','application/x-www-form-urlencoded; charset=UTF-8')),void 0!==s&&null!==s&&void 0!==s.options&&(r.timeout=s.options.timeout),n<=2e3&&a.cors)r.send(null);else{if(!(n>2e3&&a.cors))return n<=2e3&&!a.cors?v(t,e,i,s):void u('a request to '+t+' was longer then 2000 characters and this browser cannot make a cross-domain post request. Please use a proxy http://esri.github.io/esri-leaflet/api-reference/request.html');r.send(o)};return r};function v(t,i,s,r){window._EsriLeafletCallbacks=window._EsriLeafletCallbacks||{};var n='c'+yt;i.callback='window._EsriLeafletCallbacks.'+n,window._EsriLeafletCallbacks[n]=function(t){if(!0!==window._EsriLeafletCallbacks[n]){var e,i=Object.prototype.toString.call(t);'[object Object]'!==i&&'[object Array]'!==i&&(e={error:{code:500,message:'Expected array or object as JSONP response'}},t=null),!e&&t.error&&(e=t,t=null),s.call(r,e,t),window._EsriLeafletCallbacks[n]=!0}};var o=e.DomUtil.create('script',null,document.body);return o.type='text/javascript',o.src=t+'?'+T(i),o.id=n,e.DomUtil.addClass(o,'esri-leaflet-jsonp'),yt++,{id:n,url:o.src,abort:function(){window._EsriLeafletCallbacks._callback[n]({code:0,message:'Request aborted.'})}}};function Ot(t,e){for(var i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0};function O(t){return Ot(t[0],t[t.length-1])||t.push(t[0]),t};function C(t){var i,r=0,e=0,n=t.length,s=t[e];for(e;e<n-1;e++)i=t[e+1],r+=(i[0]-s[0])*(i[1]+s[1]),s=i;return r>=0};function Pt(t,e,i,s){var a=(s[0]-i[0])*(t[1]-i[1])-(s[1]-i[1])*(t[0]-i[0]),u=(e[0]-t[0])*(t[1]-i[1])-(e[1]-t[1])*(t[0]-i[0]),r=(s[1]-i[1])*(e[0]-t[0])-(s[0]-i[0])*(e[1]-t[1]);if(0!==r){var n=a/r,o=u/r;if(n>=0&&n<=1&&o>=0&&o<=1)return!0};return!1};function K(t,e){for(var s=0;s<t.length-1;s++)for(var i=0;i<e.length-1;i++)if(Pt(t[s],t[s+1],e[i],e[i+1]))return!0;return!1};function wt(t,e){for(var r=!1,i=-1,n=t.length,s=n-1;++i<n;s=i)(t[i][1]<=e[1]&&e[1]<t[s][1]||t[s][1]<=e[1]&&e[1]<t[i][1])&&e[0]<(t[s][0]-t[i][0])*(e[1]-t[i][1])/(t[s][1]-t[i][1])+t[i][0]&&(r=!r);return r};function At(t,e){var i=K(t,e),s=wt(t,e[0]);return!(i||!s)};function Tt(t){for(var i,n,s,e=[],a=[],u=0;u<t.length;u++){var r=O(t[u].slice(0));if(!(r.length<4))if(C(r)){var c=[r];e.push(c)}
else a.push(r)};for(var o=[];a.length;){s=a.pop();var h=!1;for(i=e.length-1;i>=0;i--)if(n=e[i][0],At(n,s)){e[i].push(s),h=!0;break};h||o.push(s)};for(;o.length;){s=o.pop();var l=!1;for(i=e.length-1;i>=0;i--)if(n=e[i][0],K(n,s)){e[i].push(s),l=!0;break};l||e.push([s.reverse()])};return 1===e.length?{type:'Polygon',coordinates:e[0]}:{type:'MultiPolygon',coordinates:e}};function ft(t){var r=[],n=t.slice(0),i=O(n.shift().slice(0));if(i.length>=4){C(i)||i.reverse(),r.push(i);for(var s=0;s<n.length;s++){var e=O(n[s].slice(0));e.length>=4&&(C(e)&&e.reverse(),r.push(e))}};return r};function vt(t){for(var r=[],i=0;i<t.length;i++)for(var s=ft(t[i]),e=s.length-1;e>=0;e--){var n=s[e].slice(0);r.push(n)};return r};function ut(t){var i={};for(var e in t)t.hasOwnProperty(e)&&(i[e]=t[e]);return i};function X(t,e){var i={};return'number'==typeof t.x&&'number'==typeof t.y&&(i.type='Point',i.coordinates=[t.x,t.y],'number'==typeof t.z&&i.coordinates.push(t.z)),t.points&&(i.type='MultiPoint',i.coordinates=t.points.slice(0)),t.paths&&(1===t.paths.length?(i.type='LineString',i.coordinates=t.paths[0].slice(0)):(i.type='MultiLineString',i.coordinates=t.paths.slice(0))),t.rings&&(i=Tt(t.rings.slice(0))),(t.geometry||t.attributes)&&(i.type='Feature',i.geometry=t.geometry?X(t.geometry):null,i.properties=t.attributes?ut(t.attributes):null,t.attributes&&(i.id=t.attributes[e]||t.attributes.OBJECTID||t.attributes.FID)),JSON.stringify(i.geometry)===JSON.stringify({})&&(i.geometry=null),i};function S(t,e){e=e||'OBJECTID';var s,r={wkid:4326},i={};switch(t.type){case'Point':i.x=t.coordinates[0],i.y=t.coordinates[1],i.spatialReference=r;break;case'MultiPoint':i.points=t.coordinates.slice(0),i.spatialReference=r;break;case'LineString':i.paths=[t.coordinates.slice(0)],i.spatialReference=r;break;case'MultiLineString':i.paths=t.coordinates.slice(0),i.spatialReference=r;break;case'Polygon':i.rings=ft(t.coordinates.slice(0)),i.spatialReference=r;break;case'MultiPolygon':i.rings=vt(t.coordinates.slice(0)),i.spatialReference=r;break;case'Feature':t.geometry&&(i.geometry=S(t.geometry,e)),i.attributes=t.properties?ut(t.properties):{},t.id&&(i.attributes[e]=t.id);break;case'FeatureCollection':for(i=[],s=0;s<t.features.length;s++)i.push(S(t.features[s],e));break;case'GeometryCollection':for(i=[],s=0;s<t.geometries.length;s++)i.push(S(t.geometries[s],e))};return i};function p(t,e){return S(t,e)};function V(t,e){return X(t,e)};function k(t){if('NaN'!==t.xmin&&'NaN'!==t.ymin&&'NaN'!==t.xmax&&'NaN'!==t.ymax){var i=e.latLng(t.ymin,t.xmin),s=e.latLng(t.ymax,t.xmax);return e.latLngBounds(i,s)};return null};function F(t){return t=e.latLngBounds(t),{xmin:t.getSouthWest().lng,ymin:t.getSouthWest().lat,xmax:t.getNorthEast().lng,ymax:t.getNorthEast().lat,spatialReference:{wkid:4326}}};function J(t){var i;if(t.objectIdFieldName)i=t.objectIdFieldName;else if(t.fields){for(var e=0;e<=t.fields.length-1;e++)if('esriFieldTypeOID'===t.fields[e].type){i=t.fields[e].name;break};if(!i)for(e=0;e<=t.fields.length-1;e++)if(t.fields[e].name.match(et)){i=t.fields[e].name;break}};return i};function Z(t){for(var e in t.attributes)if(e.match(et))return e};function h(t,e){var n,s=t.features||t.results,a=s.length;n=e||J(t);var r={type:'FeatureCollection',features:[]};if(a)for(var i=s.length-1;i>=0;i--){var o=V(s[i],n||Z(s[i]));r.features.push(o)};return r};function g(t){return t=e.Util.trim(t),'/'!==t[t.length-1]&&(t+='/'),t};function o(t){if(-1!==t.url.indexOf('?')){t.requestParams=t.requestParams||{};var e=t.url.substring(t.url.indexOf('?')+1);t.url=t.url.split('?')[0],t.requestParams=JSON.parse('{"'+decodeURI(e).replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"')+'"}')};return t.url=g(t.url.split('?')[0]),t};function B(t){return/^(?!.*utility\.arcgis\.com).*\.arcgis\.com.*FeatureServer/i.test(t)};function q(t){var e;switch(t){case'Point':e='esriGeometryPoint';break;case'MultiPoint':e='esriGeometryMultipoint';break;case'LineString':case'MultiLineString':e='esriGeometryPolyline';break;case'Polygon':case'MultiPolygon':e='esriGeometryPolygon'};return e};function u(){console&&console.warn&&console.warn.apply(console,arguments)};function f(t){return t.getSize().x-ct.attributionWidthOffset+'px'};function c(t){if(t.attributionControl&&!t.attributionControl._esriAttributionAdded){t.attributionControl.setPrefix('<a href="http://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> | Powered by <a href="https://www.esri.com">Esri</a>');var s=document.createElement('style');s.type='text/css',s.innerHTML='.esri-truncated-attribution:hover {white-space: normal;}',document.getElementsByTagName('head')[0].appendChild(s),e.DomUtil.addClass(t.attributionControl._container,'esri-truncated-attribution:hover');var i=document.createElement('style');i.type='text/css',i.innerHTML='.esri-truncated-attribution {vertical-align: -3px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;display: inline-block;transition: 0s white-space;transition-delay: 1s;max-width: '+f(t)+';}',document.getElementsByTagName('head')[0].appendChild(i),e.DomUtil.addClass(t.attributionControl._container,'esri-truncated-attribution'),t.on('resize',function(e){t.attributionControl._container.style.maxWidth=f(e.target)}),t.on('unload',function(){s.parentNode.removeChild(s),i.parentNode.removeChild(i);for(var e=document.querySelectorAll('.esri-leaflet-jsonp'),t=0;t<e.length;t++)e.item(t).parentNode.removeChild(e.item(t))}),t.attributionControl._esriAttributionAdded=!0}};function D(t){var i={geometry:null,geometryType:null};return t instanceof e.LatLngBounds?(i.geometry=F(t),i.geometryType='esriGeometryEnvelope',i):(t.getLatLng&&(t=t.getLatLng()),t instanceof e.LatLng&&(t={type:'Point',coordinates:[t.lng,t.lat]}),t instanceof e.GeoJSON&&(t=t.getLayers()[0].feature.geometry,i.geometry=p(t),i.geometryType=q(t.type)),t.toGeoJSON&&(t=t.toGeoJSON()),'Feature'===t.type&&(t=t.geometry),'Point'===t.type||'LineString'===t.type||'Polygon'===t.type||'MultiPolygon'===t.type?(i.geometry=p(t),i.geometryType=q(t.type),i):void u('invalid geometry passed to spatial query. Should be L.LatLng, L.LatLngBounds, L.Marker or a GeoJSON Point, Line, Polygon or MultiPolygon object'))};function Q(t,i){v(t,{},e.Util.bind(function(t,s){if(!t){i._esriAttributions=[];for(var a=0;a<s.contributors.length;a++)for(var n=s.contributors[a],o=0;o<n.coverageAreas.length;o++){var r=n.coverageAreas[o],u=e.latLng(r.bbox[0],r.bbox[1]),l=e.latLng(r.bbox[2],r.bbox[3]);i._esriAttributions.push({attribution:n.attribution,score:r.score,bounds:e.latLngBounds(u,l),minZoom:r.zoomMin,maxZoom:r.zoomMax})};i._esriAttributions.sort(function(t,e){return e.score-t.score});R({target:i})}},this))};function R(t){var i=t.target,o=i._esriAttributions;if(i&&i.attributionControl&&o){for(var s='',l=i.getBounds(),c=e.latLngBounds(l.getSouthWest().wrap(),l.getNorthEast().wrap()),h=i.getZoom(),n=0;n<o.length;n++){var r=o[n],u=r.attribution;!s.match(u)&&r.bounds.intersects(c)&&h>=r.minZoom&&h<=r.maxZoom&&(s+=', '+u)};s=s.substr(2);var a=i.attributionControl._container.querySelector('.esri-dynamic-attribution');a.innerHTML=s,a.style.maxWidth=f(i),i.fire('attributionupdated',{attribution:s})}};function Ct(t){return t=o(t),new d(t)};function y(t){return new it(t)};function H(t){return new st(t)};function Rt(t){return new A(t)};function W(t){return new rt(t)};function j(t){return new nt(t)};function It(t){return t=o(t),new l(t)};function U(t){return new ot(t)};function N(t){return new at(t)};function z(t){return new ht(t)};function St(t,e){return new w(t,e)};function xt(t,e){return new E(t,e)};function Lt(t,e){return new lt(t,e)};function bt(t,e){return new Y(t,e)};function r(t){this.values=[].concat(t||[])};function kt(t){return new tt(t)};var s='default'in e?e.default:e,b=window.XMLHttpRequest&&'withCredentials'in new window.XMLHttpRequest,n=''===document.documentElement.style.pointerEvents,a={cors:b,pointerEvents:n},ct={attributionWidthOffset:55},yt=0,P=a.cors?dt:v;P.CORS=dt,P.JSONP=v;var x={request:mt,get:P,post:pt},et=/^(OBJECTID|FID|OID|ID)$/i,gt={warn:u,cleanUrl:g,getUrlParams:o,isArcgisOnline:B,geojsonTypeToArcGIS:q,responseToFeatureCollection:h,geojsonToArcGIS:p,arcgisToGeoJSON:V,boundsToExtent:F,extentToBounds:k,calcAttributionWidth:f,setEsriAttribution:c,_setGeometry:D,_getAttributionData:Q,_updateMapAttribution:R,_findIdAttributeFromFeature:Z,_findIdAttributeFromResponse:J},d=e.Class.extend({options:{proxy:!1,useCors:b},generateSetter:function(t,i){return e.Util.bind(function(e){return this.params[t]=e,this},i)},initialize:function(t){if(t.request&&t.options?(this._service=t,e.Util.setOptions(this,t.options)):(e.Util.setOptions(this,t),this.options.url=g(t.url)),this.params=e.Util.extend({},this.params||{}),this.setters)for(var i in this.setters){var s=this.setters[i];this[i]=this.generateSetter(s,this)}},token:function(t){return this._service?this._service.authenticate(t):this.params.token=t,this},format:function(t){return this.params.returnUnformattedValues=!t,this},request:function(t,e){return this.options.requestParams&&L.extend(this.params,this.options.requestParams),this._service?this._service.request(this.path,this.params,t,e):this._request('request',this.path,this.params,t,e)},_request:function(t,e,i,s,r){var n=this.options.proxy?this.options.proxy+'?'+this.options.url+e:this.options.url+e;return'get'!==t&&'request'!==t||this.options.useCors?x[t](n,i,s,r):x.get.JSONP(n,i,s,r)}}),it=d.extend({setters:{offset:'resultOffset',limit:'resultRecordCount',fields:'outFields',precision:'geometryPrecision',featureIds:'objectIds',returnGeometry:'returnGeometry',returnM:'returnM',transform:'datumTransformation',token:'token'},path:'query',params:{returnGeometry:!0,where:'1=1',outSr:4326,outFields:'*'},within:function(t){return this._setGeometryParams(t),this.params.spatialRel='esriSpatialRelContains',this},intersects:function(t){return this._setGeometryParams(t),this.params.spatialRel='esriSpatialRelIntersects',this},contains:function(t){return this._setGeometryParams(t),this.params.spatialRel='esriSpatialRelWithin',this},crosses:function(t){return this._setGeometryParams(t),this.params.spatialRel='esriSpatialRelCrosses',this},touches:function(t){return this._setGeometryParams(t),this.params.spatialRel='esriSpatialRelTouches',this},overlaps:function(t){return this._setGeometryParams(t),this.params.spatialRel='esriSpatialRelOverlaps',this},bboxIntersects:function(t){return this._setGeometryParams(t),this.params.spatialRel='esriSpatialRelEnvelopeIntersects',this},indexIntersects:function(t){return this._setGeometryParams(t),this.params.spatialRel='esriSpatialRelIndexIntersects',this},nearby:function(t,i){return t=e.latLng(t),this.params.geometry=[t.lng,t.lat],this.params.geometryType='esriGeometryPoint',this.params.spatialRel='esriSpatialRelIntersects',this.params.units='esriSRUnit_Meter',this.params.distance=i,this.params.inSr=4326,this},where:function(t){return this.params.where=t,this},between:function(t,e){return this.params.time=[t.valueOf(),e.valueOf()],this},simplify:function(t,e){var i=Math.abs(t.getBounds().getWest()-t.getBounds().getEast());return this.params.maxAllowableOffset=i/t.getSize().y*e,this},orderBy:function(t,e){return e=e||'ASC',this.params.orderByFields=this.params.orderByFields?this.params.orderByFields+',':'',this.params.orderByFields+=[t,e].join(' '),this},run:function(t,e){return this._cleanParams(),this.options.isModern||B(this.options.url)?(this.params.f='geojson',this.request(function(i,s){this._trapSQLerrors(i),t.call(e,i,s,s)},this)):this.request(function(i,s){this._trapSQLerrors(i),t.call(e,i,s&&h(s),s)},this)},count:function(t,e){return this._cleanParams(),this.params.returnCountOnly=!0,this.request(function(e,i){t.call(this,e,i&&i.count,i)},e)},ids:function(t,e){return this._cleanParams(),this.params.returnIdsOnly=!0,this.request(function(e,i){t.call(this,e,i&&i.objectIds,i)},e)},bounds:function(t,e){return this._cleanParams(),this.params.returnExtentOnly=!0,this.request(function(i,s){s&&s.extent&&k(s.extent)?t.call(e,i,k(s.extent),s):(i={message:'Invalid Bounds'},t.call(e,i,null,s))},e)},distinct:function(){return this.params.returnGeometry=!1,this.params.returnDistinctValues=!0,this},pixelSize:function(t){var i=e.point(t);return this.params.pixelSize=[i.x,i.y],this},layer:function(t){return this.path=t+'/query',this},_trapSQLerrors:function(t){t&&'400'===t.code&&u('one common syntax error in query requests is encasing string values in double quotes instead of single quotes')},_cleanParams:function(){delete this.params.returnIdsOnly,delete this.params.returnExtentOnly,delete this.params.returnCountOnly},_setGeometryParams:function(t){this.params.inSr=4326;var e=D(t);this.params.geometry=e.geometry,this.params.geometryType=e.geometryType}}),st=d.extend({setters:{contains:'contains',text:'searchText',fields:'searchFields',spatialReference:'sr',sr:'sr',layers:'layers',returnGeometry:'returnGeometry',maxAllowableOffset:'maxAllowableOffset',precision:'geometryPrecision',dynamicLayers:'dynamicLayers',returnZ:'returnZ',returnM:'returnM',gdbVersion:'gdbVersion',token:'token'},path:'find',params:{sr:4326,contains:!0,returnGeometry:!0,returnZ:!0,returnM:!1},layerDefs:function(t,e){return this.params.layerDefs=this.params.layerDefs?this.params.layerDefs+';':'',this.params.layerDefs+=[t,e].join(':'),this},simplify:function(t,e){var i=Math.abs(t.getBounds().getWest()-t.getBounds().getEast());return this.params.maxAllowableOffset=i/t.getSize().y*e,this},run:function(t,e){return this.request(function(i,s){t.call(e,i,s&&h(s),s)},e)}}),A=d.extend({path:'identify',between:function(t,e){return this.params.time=[t.valueOf(),e.valueOf()],this}}),rt=A.extend({setters:{layers:'layers',precision:'geometryPrecision',tolerance:'tolerance',returnGeometry:'returnGeometry'},params:{sr:4326,layers:'all',tolerance:3,returnGeometry:!0},on:function(t){var e=F(t.getBounds()),i=t.getSize();return this.params.imageDisplay=[i.x,i.y,96],this.params.mapExtent=[e.xmin,e.ymin,e.xmax,e.ymax],this},at:function(t){return 2===t.length&&(t=e.latLng(t)),this._setGeometryParams(t),this},layerDef:function(t,e){return this.params.layerDefs=this.params.layerDefs?this.params.layerDefs+';':'',this.params.layerDefs+=[t,e].join(':'),this},simplify:function(t,e){var i=Math.abs(t.getBounds().getWest()-t.getBounds().getEast());return this.params.maxAllowableOffset=i/t.getSize().y*e,this},run:function(t,e){return this.request(function(i,s){if(i)return void t.call(e,i,void 0,s);var n=h(s);s.results=s.results.reverse();for(var r=0;r<n.features.length;r++){n.features[r].layerId=s.results[r].layerId};t.call(e,void 0,n,s)})},_setGeometryParams:function(t){var e=D(t);this.params.geometry=e.geometry,this.params.geometryType=e.geometryType}}),nt=A.extend({setters:{setMosaicRule:'mosaicRule',setRenderingRule:'renderingRule',setPixelSize:'pixelSize',returnCatalogItems:'returnCatalogItems',returnGeometry:'returnGeometry'},params:{returnGeometry:!1},at:function(t){return t=e.latLng(t),this.params.geometry=JSON.stringify({x:t.lng,y:t.lat,spatialReference:{wkid:4326}}),this.params.geometryType='esriGeometryPoint',this},getMosaicRule:function(){return this.params.mosaicRule},getRenderingRule:function(){return this.params.renderingRule},getPixelSize:function(){return this.params.pixelSize},run:function(t,e){return this.request(function(i,s){t.call(e,i,s&&this._responseToGeoJSON(s),s)},this)},_responseToGeoJSON:function(t){var r=t.location,n=t.catalogItems,s=t.catalogItemVisibilities,e={pixel:{type:'Feature',geometry:{type:'Point',coordinates:[r.x,r.y]},crs:{type:'EPSG',properties:{code:r.spatialReference.wkid}},properties:{OBJECTID:t.objectId,name:t.name,value:t.value},id:t.objectId}};if(t.properties&&t.properties.Values&&(e.pixel.properties.values=t.properties.Values),n&&n.features&&(e.catalogItems=h(n),s&&s.length===e.catalogItems.features.length))for(var i=s.length-1;i>=0;i--)e.catalogItems.features[i].properties.catalogItemVisibility=s[i];return e}}),l=e.Evented.extend({options:{proxy:!1,useCors:b,timeout:0},initialize:function(t){t=t||{},this._requestQueue=[],this._authenticating=!1,e.Util.setOptions(this,t),this.options.url=g(this.options.url)},get:function(t,e,i,s){return this._request('get',t,e,i,s)},post:function(t,e,i,s){return this._request('post',t,e,i,s)},request:function(t,e,i,s){return this._request('request',t,e,i,s)},metadata:function(t,e){return this._request('get','',{},t,e)},authenticate:function(t){return this._authenticating=!1,this.options.token=t,this._runQueue(),this},getTimeout:function(){return this.options.timeout},setTimeout:function(t){this.options.timeout=t},_request:function(t,e,i,s,r){this.fire('requeststart',{url:this.options.url+e,params:i,method:t},!0);var o=this._createServiceCallback(t,e,i,s,r);if(this.options.token&&(i.token=this.options.token),this.options.requestParams&&L.extend(i,this.options.requestParams),this._authenticating)return void this._requestQueue.push([t,e,i,s,r]);var n=this.options.proxy?this.options.proxy+'?'+this.options.url+e:this.options.url+e;return'get'!==t&&'request'!==t||this.options.useCors?x[t](n,i,o,r):x.get.JSONP(n,i,o,r)},_createServiceCallback:function(t,i,s,r,n){return e.Util.bind(function(o,a){!o||499!==o.code&&498!==o.code||(this._authenticating=!0,this._requestQueue.push([t,i,s,r,n]),this.fire('authenticationrequired',{authenticate:e.Util.bind(this.authenticate,this)},!0),o.authenticate=e.Util.bind(this.authenticate,this)),r.call(n,o,a),o?this.fire('requesterror',{url:this.options.url+i,params:s,message:o.message,code:o.code,method:t},!0):this.fire('requestsuccess',{url:this.options.url+i,params:s,response:a,method:t},!0),this.fire('requestend',{url:this.options.url+i,params:s,method:t},!0)},this)},_runQueue:function(){for(var t=this._requestQueue.length-1;t>=0;t--){var e=this._requestQueue[t];this[e.shift()].apply(this,e)};this._requestQueue=[]}}),ot=l.extend({identify:function(){return W(this)},find:function(){return H(this)},query:function(){return y(this)}}),at=l.extend({query:function(){return y(this)},identify:function(){return j(this)}}),ht=l.extend({options:{idAttribute:'OBJECTID'},query:function(){return y(this)},addFeature:function(t,e,i){return delete t.id,t=p(t),this.post('addFeatures',{features:[t]},function(t,s){var r=s&&s.addResults?s.addResults[0]:void 0;e&&e.call(i,t||s.addResults[0].error,r)},i)},updateFeature:function(t,e,i){return t=p(t,this.options.idAttribute),this.post('updateFeatures',{features:[t]},function(t,s){var r=s&&s.updateResults?s.updateResults[0]:void 0;e&&e.call(i,t||s.updateResults[0].error,r)},i)},deleteFeature:function(t,e,i){return this.post('deleteFeatures',{objectIds:t},function(t,s){var r=s&&s.deleteResults?s.deleteResults[0]:void 0;e&&e.call(i,t||s.deleteResults[0].error,r)},i)},deleteFeatures:function(t,e,i){return this.post('deleteFeatures',{objectIds:t},function(t,s){var r=s&&s.deleteResults?s.deleteResults:void 0;e&&e.call(i,t||s.deleteResults[0].error,r)},i)}}),i='https:'!==window.location.protocol?'http:':'https:',w=e.TileLayer.extend({statics:{TILES:{Streets:{urlTemplate:i+'//{s}.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',options:{minZoom:1,maxZoom:19,subdomains:['server','services'],attribution:'USGS, NOAA',attributionUrl:'https://static.arcgis.com/attribution/World_Street_Map'}},Topographic:{urlTemplate:i+'//{s}.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',options:{minZoom:1,maxZoom:19,subdomains:['server','services'],attribution:'USGS, NOAA',attributionUrl:'https://static.arcgis.com/attribution/World_Topo_Map'}},Oceans:{urlTemplate:i+'//{s}.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}',options:{minZoom:1,maxZoom:16,subdomains:['server','services'],attribution:'USGS, NOAA',attributionUrl:'https://static.arcgis.com/attribution/Ocean_Basemap'}},OceansLabels:{urlTemplate:i+'//{s}.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Reference/MapServer/tile/{z}/{y}/{x}',options:{minZoom:1,maxZoom:16,subdomains:['server','services'],pane:n?'esri-labels':'tilePane'}},NationalGeographic:{urlTemplate:i+'//{s}.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}',options:{minZoom:1,maxZoom:16,subdomains:['server','services'],attribution:'National Geographic, DeLorme, HERE, UNEP-WCMC, USGS, NASA, ESA, METI, NRCAN, GEBCO, NOAA, increment P Corp.'}},DarkGray:{urlTemplate:i+'//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}',options:{minZoom:1,maxZoom:16,subdomains:['server','services'],attribution:'HERE, DeLorme, MapmyIndia, &copy; OpenStreetMap contributors'}},DarkGrayLabels:{urlTemplate:i+'//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Reference/MapServer/tile/{z}/{y}/{x}',options:{minZoom:1,maxZoom:16,subdomains:['server','services'],pane:n?'esri-labels':'tilePane',attribution:''}},Gray:{urlTemplate:i+'//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}',options:{minZoom:1,maxZoom:16,subdomains:['server','services'],attribution:'HERE, DeLorme, MapmyIndia, &copy; OpenStreetMap contributors'}},GrayLabels:{urlTemplate:i+'//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}',options:{minZoom:1,maxZoom:16,subdomains:['server','services'],pane:n?'esri-labels':'tilePane',attribution:''}},Imagery:{urlTemplate:i+'//{s}.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',options:{minZoom:1,maxZoom:19,subdomains:['server','services'],attribution:'DigitalGlobe, GeoEye, i-cubed, USDA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community'}},ImageryLabels:{urlTemplate:i+'//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',options:{minZoom:1,maxZoom:19,subdomains:['server','services'],pane:n?'esri-labels':'tilePane',attribution:''}},ImageryTransportation:{urlTemplate:i+'//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}',options:{minZoom:1,maxZoom:19,subdomains:['server','services'],pane:n?'esri-labels':'tilePane'}},ShadedRelief:{urlTemplate:i+'//{s}.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}',options:{minZoom:1,maxZoom:13,subdomains:['server','services'],attribution:'USGS'}},ShadedReliefLabels:{urlTemplate:i+'//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places_Alternate/MapServer/tile/{z}/{y}/{x}',options:{minZoom:1,maxZoom:12,subdomains:['server','services'],pane:n?'esri-labels':'tilePane',attribution:''}},Terrain:{urlTemplate:i+'//{s}.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}',options:{minZoom:1,maxZoom:13,subdomains:['server','services'],attribution:'USGS, NOAA'}},TerrainLabels:{urlTemplate:i+'//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Reference_Overlay/MapServer/tile/{z}/{y}/{x}',options:{minZoom:1,maxZoom:13,subdomains:['server','services'],pane:n?'esri-labels':'tilePane',attribution:''}},USATopo:{urlTemplate:i+'//{s}.arcgisonline.com/ArcGIS/rest/services/USA_Topo_Maps/MapServer/tile/{z}/{y}/{x}',options:{minZoom:1,maxZoom:15,subdomains:['server','services'],attribution:'USGS, National Geographic Society, i-cubed'}}}},initialize:function(t,i){var s;if('object'==typeof t&&t.urlTemplate&&t.options)s=t;else{if('string'!=typeof t||!w.TILES[t])throw new Error('L.esri.BasemapLayer: Invalid parameter. Use one of "Streets", "Topographic", "Oceans", "OceansLabels", "NationalGeographic", "Gray", "GrayLabels", "DarkGray", "DarkGrayLabels", "Imagery", "ImageryLabels", "ImageryTransportation", "ShadedRelief", "ShadedReliefLabels", "Terrain", "TerrainLabels" or "USATopo"');s=w.TILES[t]};var r=e.Util.extend(s.options,i);e.Util.setOptions(this,r),this.options.token&&(s.urlTemplate+='?token='+this.options.token),e.TileLayer.prototype.initialize.call(this,s.urlTemplate,r)},onAdd:function(t){c(t),'esri-labels'===this.options.pane&&this._initPane(),this.options.attributionUrl&&Q(this.options.attributionUrl,t),t.on('moveend',R),e.TileLayer.prototype.onAdd.call(this,t)},onRemove:function(t){t.off('moveend',R),e.TileLayer.prototype.onRemove.call(this,t)},_initPane:function(){if(!this._map.getPane(this.options.pane)){var t=this._map.createPane(this.options.pane);t.style.pointerEvents='none',t.style.zIndex=500}},getAttribution:function(){if(this.options.attribution)var t='<span class="esri-dynamic-attribution">'+this.options.attribution+'</span>';return t}}),E=e.TileLayer.extend({options:{zoomOffsetAllowance:.1,errorTileUrl:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEABAMAAACuXLVVAAAAA1BMVEUzNDVszlHHAAAAAXRSTlMAQObYZgAAAAlwSFlzAAAAAAAAAAAB6mUWpAAAADZJREFUeJztwQEBAAAAgiD/r25IQAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA7waBAAABw08RwAAAAABJRU5ErkJggg=='},statics:{MercatorZoomLevels:{0:156543.033928,1:78271.5169639999,2:39135.7584820001,3:19567.8792409999,4:9783.93962049996,5:4891.96981024998,6:2445.98490512499,7:1222.99245256249,8:611.49622628138,9:305.748113140558,10:152.874056570411,11:76.4370282850732,12:38.2185141425366,13:19.1092570712683,14:9.55462853563415,15:4.77731426794937,16:2.38865713397468,17:1.19432856685505,18:.597164283559817,19:.298582141647617,20:.14929107082381,21:.07464553541191,22:.0373227677059525,23:.0186613838529763}},initialize:function(t){t=e.Util.setOptions(this,t),t=o(t),this.tileUrl=t.url+'tile/{z}/{y}/{x}'+(t.requestParams&&Object.keys(t.requestParams).length>0?e.Util.getParamString(t.requestParams):''),-1!==t.url.indexOf('{s}')&&t.subdomains&&(t.url=t.url.replace('{s}',t.subdomains[0])),this.service=U(t),this.service.addEventParent(this),new RegExp(/tiles.arcgis(online)?\.com/g).test(t.url)&&(this.tileUrl=this.tileUrl.replace('://tiles','://tiles{s}'),t.subdomains=['1','2','3','4']),this.options.token&&(this.tileUrl+='?token='+this.options.token),e.TileLayer.prototype.initialize.call(this,this.tileUrl,t)},getTileUrl:function(t){var i=this._getZoomForUrl();return e.Util.template(this.tileUrl,e.Util.extend({s:this._getSubdomain(t),x:t.x,y:t.y,z:this._lodMap&&this._lodMap[i]?this._lodMap[i]:i},this.options))},createTile:function(t,e){var i=document.createElement('img');return L.DomEvent.on(i,'load',L.bind(this._tileOnLoad,this,e,i)),L.DomEvent.on(i,'error',L.bind(this._tileOnError,this,e,i)),this.options.crossOrigin&&(i.crossOrigin=''),i.alt='',!this._lodMap||this._lodMap&&this._lodMap[this._getZoomForUrl()]?i.src=this.getTileUrl(t):this.once('lodmap',function(){i.src=this.getTileUrl(t)},this),i},onAdd:function(t){c(t),this._lodMap||this.metadata(function(e,i){if(!e&&i.spatialReference){var l=i.spatialReference.latestWkid||i.spatialReference.wkid;if(!this.options.attribution&&t.attributionControl&&i.copyrightText&&(this.options.attribution=i.copyrightText,t.attributionControl.addAttribution(this.getAttribution())),t.options.crs!==L.CRS.EPSG3857||102100!==l&&3857!==l)proj4||u('L.esri.TiledMapLayer is using a non-mercator spatial reference. Support may be available through Proj4Leaflet http://esri.github.io/esri-leaflet/examples/non-mercator-projection.html');else{this._lodMap={};for(var o=i.tileInfo.lods,a=E.MercatorZoomLevels,s=0;s<o.length;s++){var n=o[s];for(var r in a){var h=a[r];if(this._withinPercentage(n.resolution,h,this.options.zoomOffsetAllowance)){this._lodMap[r]=n.level;break}}};this.fire('lodmap')}}},this),e.TileLayer.prototype.onAdd.call(this,t)},metadata:function(t,e){return this.service.metadata(t,e),this},identify:function(){return this.service.identify()},find:function(){return this.service.find()},query:function(){return this.service.query()},authenticate:function(t){var e='?token='+t;return this.tileUrl=this.options.token?this.tileUrl.replace(/\?token=(.+)/g,e):this.tileUrl+e,this.options.token=t,this.service.authenticate(t),this},_withinPercentage:function(t,e,i){return Math.abs(t/e-1)<i}}),Ft=e.ImageOverlay.extend({onAdd:function(t){this._topLeft=t.getPixelBounds().min,e.ImageOverlay.prototype.onAdd.call(this,t)},_reset:function(){this._map.options.crs===e.CRS.EPSG3857?e.ImageOverlay.prototype._reset.call(this):e.DomUtil.setPosition(this._image,this._topLeft.subtract(this._map.getPixelOrigin()))}}),G=e.Layer.extend({options:{opacity:1,position:'front',f:'image',useCors:b,attribution:null,interactive:!1,alt:''},onAdd:function(t){c(t),this._update=e.Util.throttle(this._update,this.options.updateInterval,this),t.on('moveend',this._update,this),this._currentImage&&this._currentImage._bounds.equals(this._map.getBounds())?t.addLayer(this._currentImage):this._currentImage&&(this._map.removeLayer(this._currentImage),this._currentImage=null),this._update(),this._popup&&(this._map.on('click',this._getPopupData,this),this._map.on('dblclick',this._resetPopupState,this)),this.metadata(function(e,i){!e&&!this.options.attribution&&t.attributionControl&&i.copyrightText&&(this.options.attribution=i.copyrightText,t.attributionControl.addAttribution(this.getAttribution()))},this)},onRemove:function(t){this._currentImage&&this._map.removeLayer(this._currentImage),this._popup&&(this._map.off('click',this._getPopupData,this),this._map.off('dblclick',this._resetPopupState,this)),this._map.off('moveend',this._update,this)},bindPopup:function(t,i){return this._shouldRenderPopup=!1,this._lastClick=!1,this._popup=e.popup(i),this._popupFunction=t,this._map&&(this._map.on('click',this._getPopupData,this),this._map.on('dblclick',this._resetPopupState,this)),this},unbindPopup:function(){return this._map&&(this._map.closePopup(this._popup),this._map.off('click',this._getPopupData,this),this._map.off('dblclick',this._resetPopupState,this)),this._popup=!1,this},bringToFront:function(){return this.options.position='front',this._currentImage&&this._currentImage.bringToFront(),this},bringToBack:function(){return this.options.position='back',this._currentImage&&this._currentImage.bringToBack(),this},getAttribution:function(){return this.options.attribution},getOpacity:function(){return this.options.opacity},setOpacity:function(t){return this.options.opacity=t,this._currentImage&&this._currentImage.setOpacity(t),this},getTimeRange:function(){return[this.options.from,this.options.to]},setTimeRange:function(t,e){return this.options.from=t,this.options.to=e,this._update(),this},metadata:function(t,e){return this.service.metadata(t,e),this},authenticate:function(t){return this.service.authenticate(t),this},redraw:function(){this._update()},_renderImage:function(t,e,i){if(this._map){i&&(t='data:'+i+';base64,'+t);var s=new Ft(t,e,{opacity:0,crossOrigin:this.options.useCors,alt:this.options.alt,pane:this.options.pane||this.getPane(),interactive:this.options.interactive}).addTo(this._map),n=function(){this._map.removeLayer(s),this.fire('error'),s.off('load',r,this)},r=function(t){if(s.off('error',r,this),this._map){var n=t.target,i=this._currentImage;n._bounds.equals(e)&&n._bounds.equals(this._map.getBounds())?(this._currentImage=n,'front'===this.options.position?this.bringToFront():this.bringToBack(),this._map&&this._currentImage._map?this._currentImage.setOpacity(this.options.opacity):this._currentImage._map.removeLayer(this._currentImage),i&&this._map&&this._map.removeLayer(i),i&&i._map&&i._map.removeLayer(i)):this._map.removeLayer(n)};this.fire('load',{bounds:e})};s.once('error',n,this),s.once('load',r,this),this.fire('loading',{bounds:e})}},_update:function(){if(this._map){var e=this._map.getZoom(),i=this._map.getBounds();if(!(this._animatingZoom||this._map._panTransition&&this._map._panTransition._inProgress)){if(e>this.options.maxZoom||e<this.options.minZoom)return void(this._currentImage&&(this._currentImage._map.removeLayer(this._currentImage),this._currentImage=null));var t=this._buildExportParams();L.extend(t,this.options.requestParams),t?this._requestExport(t,i):this._currentImage&&(this._currentImage._map.removeLayer(this._currentImage),this._currentImage=null)}}},_renderPopup:function(t,i,s,r){if(t=e.latLng(t),this._shouldRenderPopup&&this._lastClick.equals(t)){var n=this._popupFunction(i,s,r);n&&this._popup.setLatLng(t).setContent(n).openOn(this._map)}},_resetPopupState:function(t){this._shouldRenderPopup=!1,this._lastClick=t.latlng},_calculateBbox:function(){var i=this._map.getPixelBounds(),s=this._map.unproject(i.getBottomLeft()),r=this._map.unproject(i.getTopRight()),n=this._map.options.crs.project(r),o=this._map.options.crs.project(s),t=e.bounds(n,o);return[t.getBottomLeft().x,t.getBottomLeft().y,t.getTopRight().x,t.getTopRight().y].join(',')},_calculateImageSize:function(){var e=this._map.getPixelBounds(),t=this._map.getSize(),r=this._map.unproject(e.getBottomLeft()),n=this._map.unproject(e.getTopRight()),i=this._map.latLngToLayerPoint(n).y,s=this._map.latLngToLayerPoint(r).y;return(i>0||s<t.y)&&(t.y=s-i),t.x+','+t.y}}),lt=G.extend({options:{updateInterval:150,format:'jpgpng',transparent:!0,f:'image'},query:function(){return this.service.query()},identify:function(){return this.service.identify()},initialize:function(t){t=o(t),this.service=N(t),this.service.addEventParent(this),e.Util.setOptions(this,t)},setPixelType:function(t){return this.options.pixelType=t,this._update(),this},getPixelType:function(){return this.options.pixelType},setBandIds:function(t){return e.Util.isArray(t)?this.options.bandIds=t.join(','):this.options.bandIds=t.toString(),this._update(),this},getBandIds:function(){return this.options.bandIds},setNoData:function(t,i){return e.Util.isArray(t)?this.options.noData=t.join(','):this.options.noData=t.toString(),i&&(this.options.noDataInterpretation=i),this._update(),this},getNoData:function(){return this.options.noData},getNoDataInterpretation:function(){return this.options.noDataInterpretation},setRenderingRule:function(t){this.options.renderingRule=t,this._update()},getRenderingRule:function(){return this.options.renderingRule},setMosaicRule:function(t){this.options.mosaicRule=t,this._update()},getMosaicRule:function(){return this.options.mosaicRule},_getPopupData:function(t){var s=e.Util.bind(function(i,s,r){i||setTimeout(e.Util.bind(function(){this._renderPopup(t.latlng,i,s,r)},this),300)},this),i=this.identify().at(t.latlng);this.options.mosaicRule&&i.setMosaicRule(this.options.mosaicRule),i.run(s),this._shouldRenderPopup=!0,this._lastClick=t.latlng},_buildExportParams:function(){var e=parseInt(this._map.options.crs.code.split(':')[1],10),t={bbox:this._calculateBbox(),size:this._calculateImageSize(),format:this.options.format,transparent:this.options.transparent,bboxSR:e,imageSR:e};return this.options.from&&this.options.to&&(t.time=this.options.from.valueOf()+','+this.options.to.valueOf()),this.options.pixelType&&(t.pixelType=this.options.pixelType),this.options.interpolation&&(t.interpolation=this.options.interpolation),this.options.compressionQuality&&(t.compressionQuality=this.options.compressionQuality),this.options.bandIds&&(t.bandIds=this.options.bandIds),(0===this.options.noData||this.options.noData)&&(t.noData=this.options.noData),this.options.noDataInterpretation&&(t.noDataInterpretation=this.options.noDataInterpretation),this.service.options.token&&(t.token=this.service.options.token),this.options.renderingRule&&(t.renderingRule=JSON.stringify(this.options.renderingRule)),this.options.mosaicRule&&(t.mosaicRule=JSON.stringify(this.options.mosaicRule)),t},_requestExport:function(t,i){'json'===this.options.f?this.service.request('exportImage',t,function(t,e){t||(this.options.token&&(e.href+='?token='+this.options.token),this._renderImage(e.href,i))},this):(t.f='image',this._renderImage(this.options.url+'exportImage'+e.Util.getParamString(t),i))}}),Y=G.extend({options:{updateInterval:150,layers:!1,layerDefs:!1,timeOptions:!1,format:'png24',transparent:!0,f:'json'},initialize:function(t){t=o(t),this.service=U(t),this.service.addEventParent(this),(t.proxy||t.token)&&'json'!==t.f&&(t.f='json'),e.Util.setOptions(this,t)},getDynamicLayers:function(){return this.options.dynamicLayers},setDynamicLayers:function(t){return this.options.dynamicLayers=t,this._update(),this},getLayers:function(){return this.options.layers},setLayers:function(t){return this.options.layers=t,this._update(),this},getLayerDefs:function(){return this.options.layerDefs},setLayerDefs:function(t){return this.options.layerDefs=t,this._update(),this},getTimeOptions:function(){return this.options.timeOptions},setTimeOptions:function(t){return this.options.timeOptions=t,this._update(),this},query:function(){return this.service.query()},identify:function(){return this.service.identify()},find:function(){return this.service.find()},_getPopupData:function(t){var i,r=e.Util.bind(function(i,s,r){i||setTimeout(e.Util.bind(function(){this._renderPopup(t.latlng,i,s,r)},this),300)},this);if(i=this.options.popup?this.options.popup.on(this._map).at(t.latlng):this.identify().on(this._map).at(t.latlng),!!i.params.maxAllowableOffset||i.simplify(this._map,.5),this.options.popup&&this.options.popup.params&&this.options.popup.params.layers||(this.options.layers?i.layers('visible:'+this.options.layers.join(',')):i.layers('visible')),this.options.layerDefs&&'string'!=typeof this.options.layerDefs&&!i.params.layerDefs)for(var s in this.options.layerDefs)this.options.layerDefs.hasOwnProperty(s)&&i.layerDef(s,this.options.layerDefs[s]);i.run(r),this._shouldRenderPopup=!0,this._lastClick=t.latlng},_buildExportParams:function(){var e=parseInt(this._map.options.crs.code.split(':')[1],10),t={bbox:this._calculateBbox(),size:this._calculateImageSize(),dpi:96,format:this.options.format,transparent:this.options.transparent,bboxSR:e,imageSR:e};if(this.options.dynamicLayers&&(t.dynamicLayers=this.options.dynamicLayers),this.options.layers){if(0===this.options.layers.length)return;t.layers='show:'+this.options.layers.join(',')};return this.options.layerDefs&&(t.layerDefs='string'==typeof this.options.layerDefs?this.options.layerDefs:JSON.stringify(this.options.layerDefs)),this.options.timeOptions&&(t.timeOptions=JSON.stringify(this.options.timeOptions)),this.options.from&&this.options.to&&(t.time=this.options.from.valueOf()+','+this.options.to.valueOf()),this.service.options.token&&(t.token=this.service.options.token),this.options.proxy&&(t.proxy=this.options.proxy),this.options.disableCache&&(t._ts=Date.now()),t},_requestExport:function(t,i){'json'===this.options.f?this.service.request('export',t,function(t,e){t||(this.options.token&&(e.href+='?token='+this.options.token),this.options.proxy&&(e.href=this.options.proxy+'?'+e.href),e.href?this._renderImage(e.href,i):this._renderImage(e.imageData,i,e.contentType))},this):(t.f='image',this._renderImage(this.options.url+'export'+e.Util.getParamString(t),i))}}),m=s.Layer.extend({options:{cellSize:512,updateInterval:150},initialize:function(t){t=s.setOptions(this,t),this._zooming=!1},onAdd:function(t){this._map=t,this._update=s.Util.throttle(this._update,this.options.updateInterval,this),this._reset(),this._update()},onRemove:function(){this._map.removeEventListener(this.getEvents(),this),this._removeCells()},getEvents:function(){return{moveend:this._update,zoomstart:this._zoomstart,zoomend:this._reset}},addTo:function(t){return t.addLayer(this),this},removeFrom:function(t){return t.removeLayer(this),this},_zoomstart:function(){this._zooming=!0},_reset:function(){this._removeCells(),this._cells={},this._activeCells={},this._cellsToLoad=0,this._cellsTotal=0,this._cellNumBounds=this._getCellNumBounds(),this._resetWrap(),this._zooming=!1},_resetWrap:function(){var e=this._map,t=e.options.crs;if(!t.infinite){var i=this._getCellSize();t.wrapLng&&(this._wrapLng=[Math.floor(e.project([0,t.wrapLng[0]]).x/i),Math.ceil(e.project([0,t.wrapLng[1]]).x/i)]),t.wrapLat&&(this._wrapLat=[Math.floor(e.project([t.wrapLat[0],0]).y/i),Math.ceil(e.project([t.wrapLat[1],0]).y/i)])}},_getCellSize:function(){return this.options.cellSize},_update:function(){if(this._map){var t=this._map.getPixelBounds(),e=this._getCellSize(),i=s.bounds(t.min.divideBy(e).floor(),t.max.divideBy(e).floor());this._removeOtherCells(i),this._addCells(i),this.fire('cellsupdated')}},_addCells:function(t){var r,e,n,o=[],a=t.getCenter(),u=this._map.getZoom();for(r=t.min.y;r<=t.max.y;r++)for(e=t.min.x;e<=t.max.x;e++)n=s.point(e,r),n.z=u,this._isValidCell(n)&&o.push(n);var i=o.length;if(0!==i)for(this._cellsToLoad+=i,this._cellsTotal+=i,o.sort(function(t,e){return t.distanceTo(a)-e.distanceTo(a)}),e=0;e<i;e++)this._addCell(o[e])},_isValidCell:function(t){var i=this._map.options.crs;if(!i.infinite){var e=this._cellNumBounds;if(!i.wrapLng&&(t.x<e.min.x||t.x>e.max.x)||!i.wrapLat&&(t.y<e.min.y||t.y>e.max.y))return!1};if(!this.options.bounds)return!0;var r=this._cellCoordsToBounds(t);return s.latLngBounds(this.options.bounds).intersects(r)},_cellCoordsToBounds:function(t){var e=this._map,i=this.options.cellSize,r=t.multiplyBy(i),n=r.add([i,i]),o=e.wrapLatLng(e.unproject(r,t.z)),a=e.wrapLatLng(e.unproject(n,t.z));return s.latLngBounds(o,a)},_cellCoordsToKey:function(t){return t.x+':'+t.y},_keyToCellCoords:function(t){var e=t.split(':'),i=parseInt(e[0],10),r=parseInt(e[1],10);return s.point(i,r)},_removeOtherCells:function(t){for(var e in this._cells)t.contains(this._keyToCellCoords(e))||this._removeCell(e)},_removeCell:function(t){var e=this._activeCells[t];e&&(delete this._activeCells[t],this.cellLeave&&this.cellLeave(e.bounds,e.coords),this.fire('cellleave',{bounds:e.bounds,coords:e.coords}))},_removeCells:function(){for(var i in this._cells){var t=this._cells[i].bounds,e=this._cells[i].coords;this.cellLeave&&this.cellLeave(t,e),this.fire('cellleave',{bounds:t,coords:e})}},_addCell:function(t){this._wrapCoords(t);var i=this._cellCoordsToKey(t),e=this._cells[i];e&&!this._activeCells[i]&&(this.cellEnter&&this.cellEnter(e.bounds,t),this.fire('cellenter',{bounds:e.bounds,coords:t}),this._activeCells[i]=e),e||(e={coords:t,bounds:this._cellCoordsToBounds(t)},this._cells[i]=e,this._activeCells[i]=e,this.createCell&&this.createCell(e.bounds,t),this.fire('cellcreate',{bounds:e.bounds,coords:t}))},_wrapCoords:function(t){t.x=this._wrapLng?s.Util.wrapNum(t.x,this._wrapLng):t.x,t.y=this._wrapLat?s.Util.wrapNum(t.y,this._wrapLat):t.y},_getCellNumBounds:function(){var t=this._map.getPixelWorldBounds(),e=this._getCellSize();return t?s.bounds(t.min.divideBy(e).floor(),t.max.divideBy(e).ceil().subtract([1,1])):null}});r.prototype.query=function(t){var e=this.getIndex(t);return this.values[e]},r.prototype.getIndex=function(t){this.dirty&&this.sort();for(var e,s,r=0,i=this.values.length-1;r<=i;)if(e=(r+i)/2|0,s=this.values[Math.round(e)],+s.value<+t)r=e+1;else{if(!(+s.value>+t))return e;i=e-1};return Math.abs(~i)},r.prototype.between=function(t,e){var s=this.getIndex(t),i=this.getIndex(e);if(0===s&&0===i)return[];for(;this.values[s-1]&&this.values[s-1].value===t;)s--;for(;this.values[i+1]&&this.values[i+1].value===e;)i++;return this.values[i]&&this.values[i].value===e&&this.values[i+1]&&i++,this.values.slice(s,i)},r.prototype.insert=function(t){return this.values.splice(this.getIndex(t.value),0,t),this},r.prototype.bulkAdd=function(t,e){return this.values=this.values.concat([].concat(t||[])),e?this.sort():this.dirty=!0,this},r.prototype.sort=function(){return this.values.sort(function(t,e){return+e.value-+t.value}).reverse(),this.dirty=!1,this};var I=m.extend({options:{attribution:null,where:'1=1',fields:['*'],from:!1,to:!1,timeField:!1,timeFilterMode:'server',simplifyFactor:0,precision:6},initialize:function(t){if(m.prototype.initialize.call(this,t),t=o(t),t=e.Util.setOptions(this,t),this.service=z(t),this.service.addEventParent(this),'*'!==this.options.fields[0]){for(var s=!1,i=0;i<this.options.fields.length;i++)this.options.fields[i].match(/^(OBJECTID|FID|OID|ID)$/i)&&(s=!0);!1===s&&u('no known esriFieldTypeOID field detected in fields Array.  Please add an attribute field containing unique IDs to ensure the layer can be drawn correctly.')};this.options.timeField.start&&this.options.timeField.end?(this._startTimeIndex=new r,this._endTimeIndex=new r):this.options.timeField&&(this._timeIndex=new r),this._cache={},this._currentSnapshot=[],this._activeRequests=0},onAdd:function(t){return c(t),this.service.metadata(function(e,i){if(!e){var s=i.supportedQueryFormats,r=!1;!1===this.service.options.isModern&&(r=!0),!r&&s&&-1!==s.indexOf('geoJSON')&&(this.service.options.isModern=!0),!this.options.attribution&&t.attributionControl&&i.copyrightText&&(this.options.attribution=i.copyrightText,t.attributionControl.addAttribution(this.getAttribution()))}},this),t.on('zoomend',this._handleZoomChange,this),m.prototype.onAdd.call(this,t)},onRemove:function(t){return t.off('zoomend',this._handleZoomChange,this),m.prototype.onRemove.call(this,t)},getAttribution:function(){return this.options.attribution},createCell:function(t,e){this._visibleZoom()&&this._requestFeatures(t,e)},_requestFeatures:function(t,i,s){return this._activeRequests++,1===this._activeRequests&&this.fire('loading',{bounds:t},!0),this._buildQuery(t).run(function(r,n,o){o&&o.exceededTransferLimit&&this.fire('drawlimitexceeded'),!r&&n&&n.features.length&&e.Util.requestAnimFrame(e.Util.bind(function(){this._addFeatures(n.features,i),this._postProcessFeatures(t)},this)),r||!n||n.features.length||this._postProcessFeatures(t),r&&this._postProcessFeatures(t),s&&s.call(this,r,n)},this)},_postProcessFeatures:function(t){--this._activeRequests<=0&&this.fire('load',{bounds:t})},_cacheKey:function(t){return t.z+':'+t.x+':'+t.y},_addFeatures:function(t,e){var s=this._cacheKey(e);this._cache[s]=this._cache[s]||[];for(var r=t.length-1;r>=0;r--){var i=t[r].id;-1===this._currentSnapshot.indexOf(i)&&this._currentSnapshot.push(i),-1===this._cache[s].indexOf(i)&&this._cache[s].push(i)};this.options.timeField&&this._buildTimeIndexes(t),this.createLayers(t)},_buildQuery:function(t){var e=this.service.query().intersects(t).where(this.options.where).fields(this.options.fields).precision(this.options.precision);return this.options.requestParams&&L.extend(e.params,this.options.requestParams),this.options.simplifyFactor&&e.simplify(this._map,this.options.simplifyFactor),'server'===this.options.timeFilterMode&&this.options.from&&this.options.to&&e.between(this.options.from,this.options.to),e},setWhere:function(t,i,s){this.options.where=t&&t.length?t:'1=1';for(var a=[],r=[],u=0,l=null,p=e.Util.bind(function(t,n){if(t&&(l=t),n)for(var o=n.features.length-1;o>=0;o--)r.push(n.features[o].id);--u<=0&&this._visibleZoom()&&(this._currentSnapshot=r,e.Util.requestAnimFrame(e.Util.bind(function(){this.removeLayers(a),this.addLayers(r),i&&i.call(s,l)},this)))},this),n=this._currentSnapshot.length-1;n>=0;n--)a.push(this._currentSnapshot[n]);for(var o in this._activeCells){u++;var h=this._keyToCellCoords(o),c=this._cellCoordsToBounds(h);this._requestFeatures(c,o,p)};return this},getWhere:function(){return this.options.where},getTimeRange:function(){return[this.options.from,this.options.to]},setTimeRange:function(t,i,s,r){var a=this.options.from,u=this.options.to,n=0,l=null,p=e.Util.bind(function(e){e&&(l=e),this._filterExistingFeatures(a,u,t,i),n--,s&&n<=0&&s.call(r,l)},this);if(this.options.from=t,this.options.to=i,this._filterExistingFeatures(a,u,t,i),'server'===this.options.timeFilterMode)for(var o in this._activeCells){n++;var h=this._keyToCellCoords(o),c=this._cellCoordsToBounds(h);this._requestFeatures(c,o,p)};return this},refresh:function(){for(var t in this._activeCells){var e=this._keyToCellCoords(t),i=this._cellCoordsToBounds(e);this._requestFeatures(i,t)};this.redraw&&this.once('load',function(){this.eachFeature(function(t){this._redraw(t.feature.id)},this)},this)},_filterExistingFeatures:function(t,i,s,r){var a=t&&i?this._getFeaturesInTimeRange(t,i):this._currentSnapshot,n=this._getFeaturesInTimeRange(s,r);if(n.indexOf)for(var o=0;o<n.length;o++){var u=a.indexOf(n[o]);u>=0&&a.splice(u,1)};e.Util.requestAnimFrame(e.Util.bind(function(){this.removeLayers(a),this.addLayers(n)},this))},_getFeaturesInTimeRange:function(t,e){var i,r=[];if(this.options.timeField.start&&this.options.timeField.end){var n=this._startTimeIndex.between(t,e),o=this._endTimeIndex.between(t,e);i=n.concat(o)}
else i=this._timeIndex.between(t,e);for(var s=i.length-1;s>=0;s--)r.push(i[s].id);return r},_buildTimeIndexes:function(t){var e,i;if(this.options.timeField.start&&this.options.timeField.end){var r=[],n=[];for(e=t.length-1;e>=0;e--)i=t[e],r.push({id:i.id,value:new Date(i.properties[this.options.timeField.start])}),n.push({id:i.id,value:new Date(i.properties[this.options.timeField.end])});this._startTimeIndex.bulkAdd(r),this._endTimeIndex.bulkAdd(n)}
else{var s=[];for(e=t.length-1;e>=0;e--)i=t[e],s.push({id:i.id,value:new Date(i.properties[this.options.timeField])});this._timeIndex.bulkAdd(s)}},_featureWithinTimeRange:function(t){if(!this.options.from||!this.options.to)return!0;var e=+this.options.from.valueOf(),i=+this.options.to.valueOf();if('string'==typeof this.options.timeField){var n=+t.properties[this.options.timeField];return n>=e&&n<=i};if(this.options.timeField.start&&this.options.timeField.end){var s=+t.properties[this.options.timeField.start],r=+t.properties[this.options.timeField.end];return s>=e&&s<=i||r>=e&&r<=i}},_visibleZoom:function(){if(!this._map)return!1;var t=this._map.getZoom();return!(t>this.options.maxZoom||t<this.options.minZoom)},_handleZoomChange:function(){if(this._visibleZoom())for(var i in this._activeCells){var e=this._activeCells[i].coords,t=this._cacheKey(e);this._cache[t]&&this.addLayers(this._cache[t])}
else this.removeLayers(this._currentSnapshot),this._currentSnapshot=[]},authenticate:function(t){return this.service.authenticate(t),this},metadata:function(t,e){return this.service.metadata(t,e),this},query:function(){return this.service.query()},_getMetadata:function(t){if(this._metadata){t(void 0,this._metadata)}
else this.metadata(e.Util.bind(function(e,i){this._metadata=i,t(e,this._metadata)},this))},addFeature:function(t,i,s){this._getMetadata(e.Util.bind(function(r,n){if(r)return void(i&&i.call(this,r,null));this.service.addFeature(t,e.Util.bind(function(e,r){e||(t.properties[n.objectIdField]=r.objectId,t.id=r.objectId,this.createLayers([t])),i&&i.call(s,e,r)},this))},this))},updateFeature:function(t,e,i){this.service.updateFeature(t,function(s,r){s||(this.removeLayers([t.id],!0),this.createLayers([t])),e&&e.call(i,s,r)},this)},deleteFeature:function(t,e,i){this.service.deleteFeature(t,function(t,s){!t&&s.objectId&&this.removeLayers([s.objectId],!0),e&&e.call(i,t,s)},this)},deleteFeatures:function(t,e,i){return this.service.deleteFeatures(t,function(t,s){if(!t&&s.length>0)for(var r=0;r<s.length;r++)this.removeLayers([s[r].objectId],!0);e&&e.call(i,t,s)},this)}}),tt=I.extend({options:{cacheLayers:!0},initialize:function(t){I.prototype.initialize.call(this,t),this._originalStyle=this.options.style,this._layers={}},onRemove:function(t){for(var e in this._layers)t.removeLayer(this._layers[e]),this.fire('removefeature',{feature:this._layers[e].feature,permanent:!1},!0);return I.prototype.onRemove.call(this,t)},createNewLayer:function(t){var i=e.GeoJSON.geometryToLayer(t,this.options);return i.defaultOptions=i.options,i},_updateLayer:function(t,i){var s=[],r=this.options.coordsToLatLng||e.GeoJSON.coordsToLatLng;switch(i.properties&&(t.feature.properties=i.properties),i.geometry.type){case'Point':s=e.GeoJSON.coordsToLatLng(i.geometry.coordinates),t.setLatLng(s);break;case'LineString':s=e.GeoJSON.coordsToLatLngs(i.geometry.coordinates,0,r),t.setLatLngs(s);break;case'MultiLineString':case'Polygon':s=e.GeoJSON.coordsToLatLngs(i.geometry.coordinates,1,r),t.setLatLngs(s);break;case'MultiPolygon':s=e.GeoJSON.coordsToLatLngs(i.geometry.coordinates,2,r),t.setLatLngs(s)}},createLayers:function(t){for(var r=t.length-1;r>=0;r--){var e,s=t[r],i=this._layers[s.id];this._visibleZoom()&&i&&!this._map.hasLayer(i)&&(this._map.addLayer(i),this.fire('addfeature',{feature:i.feature},!0)),i&&this.options.simplifyFactor>0&&(i.setLatLngs||i.setLatLng)&&this._updateLayer(i,s),i||(e=this.createNewLayer(s),e.feature=s,e.addEventParent(this),this.options.onEachFeature&&this.options.onEachFeature(e.feature,e),this._layers[e.feature.id]=e,this.setFeatureStyle(e.feature.id,this.options.style),this.fire('createfeature',{feature:e.feature},!0),this._visibleZoom()&&(!this.options.timeField||this.options.timeField&&this._featureWithinTimeRange(s))&&this._map.addLayer(e))}},addLayers:function(t){for(var e=t.length-1;e>=0;e--){var i=this._layers[t[e]];i&&this._map.addLayer(i)}},removeLayers:function(t,e){for(var s=t.length-1;s>=0;s--){var r=t[s],i=this._layers[r];i&&(this.fire('removefeature',{feature:i.feature,permanent:e},!0),this._map.removeLayer(i)),i&&e&&delete this._layers[r]}},cellEnter:function(t,i){this._visibleZoom()&&!this._zooming&&this._map&&e.Util.requestAnimFrame(e.Util.bind(function(){var e=this._cacheKey(i),s=this._cellCoordsToKey(i),t=this._cache[e];this._activeCells[s]&&t&&this.addLayers(t)},this))},cellLeave:function(t,i){this._zooming||e.Util.requestAnimFrame(e.Util.bind(function(){if(this._map){var o=this._cacheKey(i),n=this._cellCoordsToKey(i),t=this._cache[o],a=this._map.getBounds();if(!this._activeCells[n]&&t){for(var s=!0,r=0;r<t.length;r++){var e=this._layers[t[r]];e&&e.getBounds&&a.intersects(e.getBounds())&&(s=!1)};s&&this.removeLayers(t,!this.options.cacheLayers),!this.options.cacheLayers&&s&&(delete this._cache[o],delete this._cells[n],delete this._activeCells[n])}}},this))},resetStyle:function(){return this.options.style=this._originalStyle,this.eachFeature(function(t){this.resetFeatureStyle(t.feature.id)},this),this},setStyle:function(t){return this.options.style=t,this.eachFeature(function(e){this.setFeatureStyle(e.feature.id,t)},this),this},resetFeatureStyle:function(t){var i=this._layers[t],s=this._originalStyle||L.Path.prototype.options;return i&&(e.Util.extend(i.options,i.defaultOptions),this.setFeatureStyle(t,s)),this},setFeatureStyle:function(t,e){var i=this._layers[t];return'function'==typeof e&&(e=e(i.feature)),i.setStyle&&i.setStyle(e),this},eachActiveFeature:function(t,e){if(this._map){var s=this._map.getBounds();for(var i in this._layers)-1!==this._currentSnapshot.indexOf(this._layers[i].feature.id)&&('function'==typeof this._layers[i].getLatLng&&s.contains(this._layers[i].getLatLng())?t.call(e,this._layers[i]):'function'==typeof this._layers[i].getBounds&&s.intersects(this._layers[i].getBounds())&&t.call(e,this._layers[i]))};return this},eachFeature:function(t,e){for(var i in this._layers)t.call(e,this._layers[i]);return this},getFeature:function(t){return this._layers[t]},bringToBack:function(){this.eachFeature(function(t){t.bringToBack&&t.bringToBack()})},bringToFront:function(){this.eachFeature(function(t){t.bringToFront&&t.bringToFront()})},redraw:function(t){return t&&this._redraw(t),this},_redraw:function(t){var i=this._layers[t],s=i.feature;if(i&&i.setIcon&&this.options.pointToLayer&&this.options.pointToLayer){var o=this.options.pointToLayer(s,e.latLng(s.geometry.coordinates[1],s.geometry.coordinates[0])),a=o.options.icon;i.setIcon(a)};if(i&&i.setStyle&&this.options.pointToLayer){var r=this.options.pointToLayer(s,e.latLng(s.geometry.coordinates[1],s.geometry.coordinates[0])),n=r.options;this.setFeatureStyle(s.id,n)};i&&i.setStyle&&this.options.style&&this.resetStyle(s.id)}});t.VERSION='2.1.2',t.Support=a,t.options=ct,t.Util=gt,t.get=P,t.post=pt,t.request=mt,t.Task=d,t.task=Ct,t.Query=it,t.query=y,t.Find=st,t.find=H,t.Identify=A,t.identify=Rt,t.IdentifyFeatures=rt,t.identifyFeatures=W,t.IdentifyImage=nt,t.identifyImage=j,t.Service=l,t.service=It,t.MapService=ot,t.mapService=U,t.ImageService=at,t.imageService=N,t.FeatureLayerService=ht,t.featureLayerService=z,t.BasemapLayer=w,t.basemapLayer=St,t.TiledMapLayer=E,t.tiledMapLayer=xt,t.RasterLayer=G,t.ImageMapLayer=lt,t.imageMapLayer=Lt,t.DynamicMapLayer=Y,t.dynamicMapLayer=bt,t.FeatureManager=I,t.FeatureLayer=tt,t.featureLayer=kt});